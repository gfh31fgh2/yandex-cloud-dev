#cloud-config
ssh_pwauth: no
users:
  - name: xxx
    groups: sudo
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - "ssh-rsa AAx xx@xx.ru"
package_update: true
package_upgrade: true
package_reboot_if_required: true
packages:
  - htop
  - build-essential
  - syslinux-utils
  - software-properties-common
  - wget
  - zip
  - unzip
  - net-tools
  - autoconf
  - cron
  - iputils-ping
  - dpkg-dev
  - curl
  - rsync
  - git
  - ssh
  - nano
  - bc
  - locales
  - python3
  - python3-pip
  - python3-dev
  - snapd
  - docker.io
  - docker-compose

runcmd:
  - python3 -m pip install --upgrade pip
  # - /usr/bin/python3 -m pip install ydb
  - mkdir -p /home/tt/xxxxmailhost
  - /bin/sh /home/entry.sh
  # - printf "*/30 * * * * root /bin/sh /home/prepare/1.sh 2>&1 | /usr/bin/logger -t checkSyslog" > /etc/cron.d/checkSyslog

write_files:
  - content: |
      # This file is auto-generated by the Mailu configuration wizard.
      # Please read the documentation before attempting any change.
      # Generated for compose flavor
      
      version: '2.2'
      
      services:
      
        # External dependencies
        redis:
          image: redis:alpine
          restart: always
          volumes:
            - "/mailu/redis:/data"
          depends_on:
            - resolver
          dns:
            - 192.168.203.254
      
        # Core services
        front:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}nginx:${MAILU_VERSION:-2.0}
          restart: always
          env_file: xxxx.env
          logging:
            driver: journald
            options:
              tag: mailu-front
          ports:
            - "x"
          networks:
            - default
            - webmail
            - radicale
          volumes:
            - "/mailu/certs:/certs"
            - "/mailu/overrides/nginx:/overrides:ro"
          depends_on:
            - resolver
          dns:
            - 192.168.203.254
      
        resolver:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}unbound:${MAILU_VERSION:-2.0}
          env_file: xxxx.env
          restart: always
          networks:
            default:
              ipv4_address: 192.168.203.254
      
        admin:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}admin:${MAILU_VERSION:-2.0}
          restart: always
          env_file: xxxx.env
          logging:
            driver: journald
            options:
              tag: mailu-admin
          volumes:
            - "/mailu/data:/data"
            - "/mailu/dkim:/dkim"
          depends_on:
            - redis
            - resolver
          dns:
            - 192.168.203.254
      
        imap:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}dovecot:${MAILU_VERSION:-2.0}
          restart: always
          env_file: xxxx.env
          logging:
            driver: journald
            options:
              tag: mailu-imap
          volumes:
            - "/mailu/mail:/mail"
            - "/mailu/overrides/dovecot:/overrides:ro"
          depends_on:
            - front
            - resolver
          dns:
            - 192.168.203.254
      
        smtp:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}postfix:${MAILU_VERSION:-2.0}
          restart: always
          env_file: xxxx.env
          logging:
            driver: journald
            options:
              tag: mailu-smtp
          volumes:
            - "/mailu/mailqueue:/queue"
            - "/mailu/overrides/postfix:/overrides:ro"
          depends_on:
            - front
            - resolver
          dns:
            - 192.168.203.254
      
        oletools:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}oletools:${MAILU_VERSION:-2.0}
          hostname: oletools
          restart: always
          networks:
            - noinet
          depends_on:
            - resolver
          dns:
            - 192.168.203.254
      
        antispam:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}rspamd:${MAILU_VERSION:-2.0}
          hostname: antispam
          restart: always
          env_file: xxxx.env
          logging:
            driver: journald
            options:
              tag: mailu-antispam
          networks:
            - default
            - noinet
          volumes:
            - "/mailu/filter:/var/lib/rspamd"
            - "/mailu/overrides/rspamd:/overrides:ro"
          depends_on:
            - front
            - redis
            - oletools
            - antivirus
            - resolver
          dns:
            - 192.168.203.254
      
        # Optional services
        antivirus:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}clamav:${MAILU_VERSION:-2.0}
          restart: always
          env_file: xxxx.env
          volumes:
            - "/mailu/filter:/data"
          depends_on:
            - resolver
          dns:
            - 192.168.203.254
      
        webdav:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}radicale:${MAILU_VERSION:-2.0}
          restart: always
          volumes:
            - "/mailu/dav:/data"
          networks:
            - radicale
      
      
        # Webmail
        webmail:
          image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}webmail:${MAILU_VERSION:-2.0}
          restart: always
          env_file: xxxx.env
          volumes:
            - "/mailu/webmail:/data"
            - "/mailu/overrides/roundcube:/overrides:ro"
          networks:
            - webmail
          depends_on:
            - front
      
      networks:
        default:
          driver: bridge
          ipam:
            driver: default
            config:
              - subnet: 192.168.203.0/24
        radicale:
          driver: bridge
        webmail:
          driver: bridge
        noinet:
          driver: bridge
          internal: true
      
    path: /home/docker-compose.yml
    owner: root:root
    permissions: '0644'
  - content: |
      # Mailu main configuration file
      #
      # This file is autogenerated by the configuration management wizard for compose flavor.
      # For a detailed list of configuration variables, see the documentation at
      # https://mailu.io
      
      ###################################
      # Common configuration variables
      ###################################
      
      # Set to a randomly generated 16 bytes string
      # deleted
    path: /home/xxxx.env
    owner: root:root
    permissions: '0644'
  - content: |
      apt update
      mkdir -p /home/tt/mailu
      mv /home/xxxx.env /home/tt/mailu/xxxx.env
      mv /home/docker-compose.yml /home/tt/mailu/docker-compose.yml
      cd /home/tt/mailu/
      docker-compose up -d
    path: /home/entry.sh
    owner: root:root
    permissions: '0755'